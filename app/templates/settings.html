{% extends "base.html" %}

{% block title %}设置 - OpenNOF1{% endblock %}

{% block content %}
<div class="settings-page">

    <!-- System Controls -->
    <section class="card">
        <div class="card-header">系统控制</div>
        <div class="card-body">
            <div class="d-flex gap-2 mb-2">
                <button id="btn-start" class="btn btn-success btn-lg">开始交易</button>
                <button id="btn-stop" class="btn btn-danger btn-lg" disabled>停止交易</button>
            </div>

            <div class="d-flex align-center gap-2 mt-2">
                <label class="form-label" style="margin-bottom: 0;">
                    <input type="checkbox" id="live-trading"> 启用实盘交易
                </label>
                <span class="badge badge-warning">⚠️ 真实订单</span>
            </div>

            <div class="mt-2">
                <button id="btn-run-once" class="btn">运行单次循环</button>
            </div>
        </div>
    </section>

    <!-- Trading Parameters -->
    <section class="card">
        <div class="card-header">交易参数</div>
        <div class="card-body">
            <div class="grid grid-2">
                <div>
                    <div class="form-group">
                        <label class="form-label">交易间隔</label>
                        <div class="alpha-value">{{ config.TRADING_INTERVAL_MINUTES }} 分钟</div>
                    </div>
                </div>
                <div>
                    <div class="form-group">
                        <label class="form-label">交易币种</label>
                        <div>
                            {% for symbol in config.TRADING_SYMBOLS %}
                            <span class="badge">{{ symbol.replace('/USDT', '') }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Custom Instructions -->
    <section class="card">
        <div class="card-header">自定义交易指令</div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">附加提示词</label>
                <textarea id="custom-instructions" class="form-control"
                    placeholder="输入给 AI 的自定义指令 (例如: '今晚有美联储会议，保持空仓')"></textarea>
                <small class="text-muted mt-1" style="display: block;">
                    此文本将附加到每个 AI 请求中。
                </small>
            </div>
            <button id="btn-save-instructions" class="btn btn-primary">保存指令</button>
        </div>
    </section>

    <!-- Memory Whiteboard -->
    <section class="card">
        <div class="card-header">AI 记忆白板</div>
        <div class="card-body">
            <div id="memory-content" class="loading">正在加载记忆...</div>
        </div>
    </section>

</div>

<script>
    // Load memory content
    async function loadMemory() {
        try {
            const response = await fetch('/api/memory');
            const data = await response.json();
            document.getElementById('memory-content').innerHTML =
                data.content ? `<pre style="white-space: pre-wrap;">${data.content}</pre>` :
                    '<span class="text-muted">暂无记忆内容。</span>';
        } catch (e) {
            document.getElementById('memory-content').textContent = '加载记忆失败。';
        }
    }

    // Load initial status
    async function loadStatus() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            const isRunning = data.running;
            document.getElementById('btn-start').disabled = isRunning;
            document.getElementById('btn-stop').disabled = !isRunning;
            document.getElementById('live-trading').checked = data.live_trading || false;
        } catch (e) {
            console.error('Failed to load status:', e);
        }
    }

    // Button event handlers
    document.getElementById('btn-start').addEventListener('click', async () => {
        try {
            const res = await fetch('/api/start', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert('交易循环已启动！');
                loadStatus();
            } else {
                alert('启动失败: ' + (data.error || '未知错误'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });

    document.getElementById('btn-stop').addEventListener('click', async () => {
        try {
            const res = await fetch('/api/stop', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert('正在停止交易循环...');
                loadStatus();
            } else {
                alert('停止失败: ' + (data.error || '未知错误'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });

    document.getElementById('btn-run-once').addEventListener('click', async (e) => {
        const btn = e.target;
        const originalText = btn.textContent;
        btn.textContent = '运行中...';
        btn.disabled = true;
        try {
            const res = await fetch('/api/run-once', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert('循环完成！');
            } else {
                alert('循环失败: ' + (data.error || '未知错误'));
            }
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    });

    document.getElementById('live-trading').addEventListener('change', async (e) => {
        const enable = e.target.checked;
        if (enable && !confirm('⚠️ 启用实盘交易？将会执行真实订单！')) {
            e.target.checked = false;
            return;
        }
        try {
            await fetch('/api/live', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable })
            });
        } catch (e) {
            alert('Error: ' + e.message);
        }
    });

    document.getElementById('btn-save-instructions').addEventListener('click', async () => {
        const instructions = document.getElementById('custom-instructions').value;
        try {
            const res = await fetch('/api/instructions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ instructions })
            });
            const data = await res.json();
            if (data.success) {
                alert('指令已保存！');
            }
        } catch (e) {
            alert('错误: ' + e.message);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadMemory();
        loadStatus();
    });
</script>
{% endblock %}